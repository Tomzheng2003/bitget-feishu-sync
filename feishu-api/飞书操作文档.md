# 飞书多维表格集成配置指南

本指南将协助你从零开始配置飞书自建应用，并解决 `91403 - Forbidden` 权限错误。

> [!IMPORTANT]
> 出现 `Forbidden` 错误最常见的原因是：**未将应用添加为多维表格的协作者**。

---

## 第一步：创建企业自建应用

1. 登录 [飞书开放平台](https://open.feishu.cn/app)
2. 点击右上角 **"创建应用"**
3. 选择 **"企业自建应用"**
4. 填写基本信息：
   - 名称：`Bitget交易同步` (或任意名称)
   - 描述：`同步交易数据`
5. 点击 **"创建"**

---

## 第二步：添加应用权限

1. 在左侧菜单点击 **"开发配置"** -> **"权限管理"**
2. 在搜索框输入 `bitable`，勾选以下权限：
   - `bitable:app` (查看、评论、编辑和管理多维表格)
   - `bitable:app:read` (查看多维表格内容) - *可选，建议加上*
3. 点击 **"批量开通"**

---

## 第三步：发布应用版本（重要！）

> [!WARNING]
> 修改权限后，**必须**重新发布应用版本才会生效。

1. 在左侧菜单点击 **"应用发布"** -> **"版本管理与发布"**
2. 点击 **"创建版本"**
3. 版本号填写 `1.0.0`，注记填写 `初始化`
4. 点击 **"保存"**
5. 点击 **"申请发布"** (如果是企业管理员，可能会直接发布；若不是，需管理员审批)

---

## 第四步：获取 App ID 和 Secret

1. 在左侧菜单点击 **"基础信息"** -> **"凭证与基础信息"**
2. 复制 **App ID** 和 **App Secret**
3. 更新你的 `.env` 文件：
   ```env
   FEISHU_APP_ID=cli_xxxxxxxx
   FEISHU_APP_SECRET=xxxxxxxxxxxxxxxx
   ```

---

## 第五步：设置多维表格（Bitable）

1. 在飞书文档中新建一个 **"多维表格"**
2. 修改表格名称为 `交易日志` (可选)
3. **添加/修改字段**（必须与程序完全一致）：
   - `开仓时间` (日期)
   - `币种` (文本)
   - `方向` (单选: 多/空)
   - `杠杆` (数字)
   - `入场价` (数字)
   - `出场价` (数字)
   - `收益额` (数字)
   - `收益率` (数字)
   - `状态` (单选: 盈利/亏损/持仓中)
   - `平仓时间` (日期) -- **[新字段]**
   - `持仓时长` (文本) -- **[新字段]**
   - `跟单员` (文本)
   - `备注` (文本)

---

## 第六步：添加应用为协作者（关键步骤！）

> [!IMPORTANT]
> **这一步是解决 Forbidden 错误的关键！**

1. 在飞书多维表格页面右上角，点击 **"..." (更多)** -> **"添加文档应用"** (或 **"协作"** -> **"添加应用"**)
2. 搜索你刚才创建的应用名称 (`Bitget交易同步`)
3. 点击 **"添加"**，确保授予 **"可编辑"** 权限

---

## 第七步：获取 App Token 和 Table ID

1. 查看多维表格的 URL，格式如下：
   `https://xxxxx.feishu.cn/base/abasexxxxxxxx?table=tblxxxxxxxx&view=vewxxxxxxx`

2.提取关键信息：
   - **FEISHU_APP_TOKEN**:  `/base/` 之后，`?` 之前的部分 (例如 `abasexxxxxxxx`)
   - **FEISHU_TABLE_ID**: `table=` 之后的部分 (例如 `tblxxxxxxxx`)

3. 更新你的 `.env` 文件：
   ```env
   FEISHU_APP_TOKEN=abasexxxxxxxx
   FEISHU_TABLE_ID=tblxxxxxxxx
   ```

---

## 第八步：重新测试

1. 在终端运行测试脚本：
   ```bash
   python3 feishu_client.py
   ```
2. 如果看到 `[飞书] 创建记录成功`，说明配置完成！
